<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>De Onderhoud Centrale</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --color-bg-primary: #fcfcf9;
      --color-surface: #fffdfd;
      --color-text: #134252;
      --color-text-secondary: #626c71;
      --color-primary: #218D8D;
      --color-primary-hover: #1d7480;
      --color-border: rgba(94, 82, 64, 0.2);
      --color-card-border: rgba(94, 82, 64, 0.12);
      --color-error: #c0152f;
      --color-success: #218D8D;
      --color-warning: #a84b2f;
      --radius-base: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
    }

    [data-theme="dark"] {
      --color-bg-primary: #1f2121;
      --color-surface: #262828;
      --color-text: #f5f5f5;
      --color-text-secondary: rgba(167, 169, 169, 0.7);
      --color-primary: #32b8c6;
      --color-primary-hover: #2da6b2;
      --color-border: rgba(119, 124, 124, 0.3);
      --color-card-border: rgba(119, 124, 124, 0.2);
    }

    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-bg-primary: #1f2121;
        --color-surface: #262828;
        --color-text: #f5f5f5;
        --color-text-secondary: rgba(167, 169, 169, 0.7);
        --color-primary: #32b8c6;
        --color-primary-hover: #2da6b2;
        --color-border: rgba(119, 124, 124, 0.3);
        --color-card-border: rgba(119, 124, 124, 0.2);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-text);
      line-height: 1.5;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: 16px 0;
      margin-bottom: 24px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-title h1 {
      font-size: 24px;
      font-weight: 600;
      color: var(--color-text);
    }

    .header-subtitle {
      font-size: 14px;
      color: var(--color-text-secondary);
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: var(--radius-base);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text);
      transition: all 0.2s;
    }

    .btn:hover {
      background: rgba(33, 141, 141, 0.1);
      border-color: var(--color-primary);
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
    }

    .filters {
      background: var(--color-surface);
      padding: 20px;
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
      border: 1px solid var(--color-card-border);
    }

    .filters-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
      align-items: end; /* Zorgt dat labels en inputs netjes uitlijnen */
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .filter-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-left: 2px;
    }

    .form-control {
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      background: var(--color-bg-primary);
      color: var(--color-text);
      font-size: 14px;
      width: 100%;
    }

    .form-control:focus {
      outline: 2px solid var(--color-primary);
      border-color: var(--color-primary);
    }

    .results-count {
      font-size: 14px;
      color: var(--color-text-secondary);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }

    .system-card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s;
    }

    .system-card:hover {
      box-shadow: var(--shadow-md);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
    }

    .card-meta {
      font-size: 13px;
      color: var(--color-warning);
      margin-top: 4px;
      font-style: italic;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: var(--radius-base);
      color: var(--color-text-secondary);
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: rgba(33, 141, 141, 0.1);
      color: var(--color-primary);
    }

    .icon-btn.active {
      color: #f59e0b;
    }

    .card-section {
      margin-bottom: 16px;
    }

    .card-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .procedure-text {
      font-size: 14px;
      color: var(--color-text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .values-grid {
      display: grid;
      gap: 8px;
    }

    .value-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(33, 141, 141, 0.05);
      border-radius: var(--radius-base);
      border: 1px solid rgba(33, 141, 141, 0.1);
    }

    .value-icon {
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .value-content {
      flex: 1;
    }

    .value-label {
      font-size: 12px;
      color: var(--color-text-secondary);
      margin-bottom: 2px;
    }

    .value-number {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text);
    }

    .notes-section {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: var(--radius-base);
      padding: 12px;
    }

    .notes-title {
      font-size: 13px;
      font-weight: 600;
      color: #d97706;
      margin-bottom: 8px;
    }

    .notes-text {
      font-size: 13px;
      color: var(--color-text-secondary);
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--color-text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-secondary);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content.wide {
      max-width: 700px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .auth-container {
      max-width: 400px;
      margin: 60px auto;
      padding: 20px;
    }

    .auth-card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-md);
    }

    .auth-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }

    .auth-subtitle {
      color: var(--color-text-secondary);
      text-align: center;
      margin-bottom: 24px;
    }

    .hidden {
      display: none !important;
    }

    .icon {
      width: 20px;
      height: 20px;
      display: inline-block;
    }

    .brand-logo {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-base);
      object-fit: contain;
      background: white;
      padding: 4px;
      border: 1px solid var(--color-card-border);
    }

    .card-header-with-logo {
      display: flex;
      gap: 12px;
      align-items: start;
    }

    .admin-section {
      background: var(--color-surface);
      padding: 24px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-card-border);
      margin-bottom: 24px;
    }

    .user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .user-table th,
    .user-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .user-table th {
      font-weight: 600;
      font-size: 14px;
      color: var(--color-text-secondary);
    }

    .role-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .role-badge.admin {
      background: rgba(192, 21, 47, 0.1);
      color: var(--color-error);
      border: 1px solid rgba(192, 21, 47, 0.2);
    }

    .role-badge.moderator {
      background: rgba(33, 141, 141, 0.1);
      color: var(--color-primary);
      border: 1px solid rgba(33, 141, 141, 0.2);
    }

    .role-badge.user {
      background: rgba(119, 124, 124, 0.1);
      color: var(--color-text-secondary);
      border: 1px solid rgba(119, 124, 124, 0.2);
    }

    .parts-list {
      background: rgba(33, 141, 141, 0.05);
      border: 1px solid rgba(33, 141, 141, 0.15);
      border-radius: var(--radius-base);
      padding: 12px;
      margin-top: 8px;
    }

    .parts-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 8px;
    }

    .parts-text {
      font-size: 13px;
      color: var(--color-text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-base);
      overflow: hidden;
      cursor: pointer;
      border: 1px solid var(--color-border);
      background: var(--color-bg-primary);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-item-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(192, 21, 47, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .gallery-item:hover .gallery-item-delete {
      opacity: 1;
    }

    .upload-zone {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-base);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-zone:hover {
      border-color: var(--color-primary);
      background: rgba(33, 141, 141, 0.05);
    }

    .upload-zone.drag-over {
      border-color: var(--color-primary);
      background: rgba(33, 141, 141, 0.1);
    }

    .upload-zone input[type="file"] {
      display: none;
    }

    .image-count {
      font-size: 12px;
      color: var(--color-text-secondary);
      margin-top: 4px;
    }

    .lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }

    .lightbox-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: var(--radius-lg);
    }

    .lightbox-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .admin-actions-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .admin-actions {
      display: flex;
      gap: 8px;
    }

    .admin-toggle-btn {
      display: none;
    }

    @media (max-width: 768px) {
      .admin-actions {
        position: absolute;
        top: 110%;
        right: 0;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-base);
        box-shadow: var(--shadow-md);
        padding: 8px;
        flex-direction: column;
        gap: 4px;
        min-width: 180px;
        display: none;
        z-index: 10;
      }

      .admin-actions.open {
        display: flex;
      }

      #adminBtn, #addSystemBtn {
        width: 100%;
      }

      .admin-toggle-btn {
        display: inline-flex;
      }
    }

    .parts-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }
    .parts-table th { text-align: left; color: var(--color-text-secondary); font-weight: 500; border-bottom: 1px solid var(--color-border); padding-bottom: 4px;}
    .parts-table td { padding: 4px 0; border-bottom: 1px solid var(--color-card-border); vertical-align: middle; }
    .parts-table tr:last-child td { border-bottom: none; }

    .tabs-nav {
      display: flex;
      border-bottom: 1px solid var(--color-card-border);
      margin-bottom: 16px;
      gap: 16px;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 8px 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--color-primary); }
    .tab-btn.active {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .fault-code { font-weight: 700; color: var(--color-error); font-family: monospace; font-size: 14px; }
    .fault-row { display: grid; grid-template-columns: 60px 1fr; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--color-card-border); }
    .fault-row:last-child { border-bottom: none; }

    .check-card {
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      padding: 12px;
      margin-bottom: 12px;
    }
    .check-title {
      font-weight: 700;
      color: var(--color-primary);
      text-transform: uppercase;
      font-size: 13px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 4px;
    }
    .check-row {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .check-label {
      font-weight: 600;
      min-width: 80px;
      color: var(--color-text-secondary);
    }
    .check-img {
      margin-top: 8px;
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid var(--color-border);
      max-height: 200px;
      object-fit: cover;
      cursor: pointer;
    }
    
    .supplier-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }
    
    .supplier-rensa { background-color: #e30613; } /* Rensa rood */
    .supplier-wasco { background-color: #004d99; } /* Wasco blauw */
    .supplier-other { background-color: #626c71; } /* grijs */

    .part-input-row {
      display: grid;
      grid-template-columns: 80px 1fr 1fr auto; 
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    @media (max-width: 600px) {
      .part-input-row {
        grid-template-columns: 1fr auto; /* Code + Verwijder knop */
        grid-template-rows: auto auto auto;
      }
      .part-input-row .fault-cause-input,
      .part-input-row .fault-sol-input {
        grid-column: 1 / -1; /* Oorzaak en Oplossing pakken volle breedte */
      }
    }

    .fault-detail-item { margin-bottom: 4px; }
    .fault-label { font-weight: 600; color: var(--color-text-secondary); font-size: 12px; text-transform: uppercase; margin-right: 4px; }
    
    .remove-part-btn {
      color: var(--color-error);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0 4px;
    }
    
    /* Nieuwe stijlen voor de header (Auto-stijl) */
    .card-header-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex: 1; 
      min-width: 0; 
    }
    
    .brand-label {
      font-size: 13px;
      font-weight: 800; /* Extra dik */
      text-transform: uppercase; /* Alles in HOOFDLETTERS */
      color: var(--color-primary); /* In de hoofdkleur van je app */
      letter-spacing: 1px;
      line-height: 1.2;
      margin-bottom: 2px;
    }
    
    .model-label {
      font-size: 18px;
      font-weight: 700;
      color: var(--color-text);
      line-height: 1.2;
    }

    .app-footer {
      margin-top: 40px;
      padding: 24px 0;
      border-top: 1px solid var(--color-border);
      text-align: center;
      color: var(--color-text-secondary);
      font-size: 13px;
    }
        
  </style>
</head>
<body>
  <div id="authContainer" class="full-screen-center" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
    <div style="background: var(--color-surface); padding: 40px; border-radius: 24px; box-shadow: var(--shadow-md); width: 100%; max-width: 400px; text-align: center;">
      <h1 style="margin-bottom: 10px;">De Onderhoud Centrale</h1>
      <p style="color: var(--color-text-secondary); margin-bottom: 30px;">Log in voor toegang</p>
      <form id="loginForm" style="display: flex; flex-direction: column; gap: 15px;">
        <input type="email" id="loginEmail" placeholder="E-mailadres" required style="padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; background: var(--color-bg-primary); color: var(--color-text);">
        <input type="password" id="loginPassword" placeholder="Wachtwoord" required style="padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; background: var(--color-bg-primary); color: var(--color-text);">
        
        <!-- Knop is nu alleen Inloggen -->
        <button type="submit" class="btn btn-primary" style="padding: 14px; justify-content: center;">Inloggen</button>
        
        <!-- Nieuw linkje voor registreren -->
        <div style="text-align: center; margin-top: 10px; font-size: 14px; color: var(--color-text-secondary);">
          Nog geen account? 
          <button type="button" onclick="openRegisterModal()" style="background: none; border: none; color: var(--color-primary); cursor: pointer; text-decoration: underline; font-weight: 600; padding: 0;">
            Maak een account aan
          </button>
        </div>
      </form>

  <div id="pendingScreen" class="full-screen-center hidden" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center;">
    <h1 style="font-size: 48px; margin-bottom: 20px;">⏳</h1>
    <h2>Toegang in afwachting</h2>
    <p id="pendingMessage" style="color: var(--color-text-secondary); margin: 20px 0; max-width: 400px;"></p>
    <div style="display: flex; gap: 10px;">
      <button onclick="location.reload()" class="btn btn-primary">Check status</button>
      <button onclick="supabase.auth.signOut()" class="btn">Uitloggen</button>
    </div>
  </div>

  <div id="appContainer" class="hidden">
    <div class="header">
      <div class="container">
        <div class="header-content">
          <div class="header-title">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <div>
              <h1>De Onderhoud Centrale</h1>
              <div class="header-subtitle">Afstelinstructies en doelwaarden voor CV-ketels, Warmtepompen en WTW/MV</div>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn icon-btn" id="themeToggle" title="Wissel dark/light mode">
              <svg class="icon" id="themeIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
              </svg>
            </button>
            <div class="admin-actions-wrapper">
              <button class="btn icon-btn admin-toggle-btn" id="adminToggleBtn" type="button" style="display: none;" title="Beheer">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0l.284 1.174a1 1 0 00.97.758h1.518a1 1 0 01.894.553l.76 1.52a1 1 0 01-.116 1.034l-.96 1.28a1 1 0 000 1.2l.96 1.28a1 1 0 01.116 1.034l-.76 1.52a1 1 0 01-.894.553h-1.518a1 1 0 00-.97.758l-.284 1.174c-.426 1.756-2.924 1.756-3.35 0l-.284-1.174a1 1 0 00-.97-.758H7.253a1 1 0 01-.894-.553l-.76-1.52a1 1 0 01.116-1.034l.96-1.28a1 1 0 000-1.2l-.96-1.28a1 1 0 01-.116-1.034l.76-1.52a1 1 0 01.894-.553h1.518a1 1 0 00.97-.758l.284-1.174z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9a3 3 0 100 6 3 3 0 000-6z"></path>
                </svg>
              </button>
              <div class="admin-actions" id="adminActions">
                <button class="btn" id="adminBtn" style="display: none;">
                  <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                  Gebruikersbeheer
                </button>
                <button class="btn" id="addSystemBtn" style="display: none;">
                  <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  Systeem toevoegen
                </button>
                <button class="btn" id="auditBtn" style="display: none;">
                  <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Audit Log
                </button>
              </div>
            </div>
            <span id="userEmail" style="font-size: 14px; color: var(--color-text-secondary);"></span>
            <button class="btn" id="logoutBtn">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
              Uitloggen
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="filters">          
        <div class="filters-row">
          <div class="form-group">
            <label class="filter-label">Categorie</label>
            <select id="systemTypeFilter" class="form-control">
            <option value="">Alle Categorieën</option>
            <option value="appendages">Appendages</option>
            <option value="collectief">Collectief</option>
            <option value="cv-ketel">CV-ketels</option>
            <option value="mv-wtw">MV/WTW</option>
            <option value="overig">Overig</option>
            <option value="rookgasafvoer">Rookgasafvoer</option>
            <option value="thermostaten">Thermostaten</option>
            <option value="warmtepomp">Warmtepompen</option>
            <option value="waterzijdig">Waterzijdig</option>
            </select>
          </div>
          <div class="form-group">
            <label class="filter-label">Merk</label>
            <select id="brandFilter" class="form-control">
              <option value="all">Alle Merken</option>
            </select>
          </div>
          <div class="form-group">
            <label class="filter-label">Model</label>
            <select id="modelFilter" class="form-control">
              <option value="all">Alle Modellen</option>
            </select>
          </div>
          <div class="form-group">
            <label class="filter-label">Favorieten</label>
            <select id="favoritesFilter" class="form-control">
              <option value="all">Alles tonen</option>
              <option value="favorites">Alleen favorieten</option>
            </select>
          </div>
        </div>
        <div class="results-count" id="resultsCount">Laden...</div>
      </div>

      <div id="loadingState" class="loading">
        <p>Systemen laden...</p>
      </div>
      <div id="cardsGrid" class="cards-grid hidden"></div>
      <div id="emptyState" class="empty-state hidden">
        <p>Geen systemen gevonden met de opgegeven criteria</p>
      </div>
      <div class="app-footer">
          &copy; <span id="currentYear"></span> <strong id="copyrightName" style="cursor: pointer; user-select: none;" title="???">K.W. Diets</strong>. Alle rechten voorbehouden.
      </div>
    </div>
  </div>

  <div id="adminModal" class="modal">
    <div class="modal-content wide">
      <div class="modal-header">
        <h2 class="modal-title">Gebruikersbeheer</h2>
        <button class="icon-btn" onclick="closeAdminModal()">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="admin-section" style="border-bottom: 2px solid var(--color-border); margin-bottom: 20px; padding-bottom: 20px;">
          <h3 style="margin-bottom: 16px; color: var(--color-warning);">⏳ Wacht op goedkeuring</h3>
          <div id="pendingUsersList">
             <!-- Hier komen de wachtende gebruikers -->
             <p style="font-size:13px; color:var(--color-text-secondary);">Laden...</p>
          </div>
        </div>

        <div class="admin-section">
          <h3 style="margin-bottom: 16px;">Alle gebruikers en rollen</h3>
          <table class="user-table" id="usersTable">
            <thead>
              <tr>
                <th>E-mail</th>
                <th>Rol</th>
                <th>Acties</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr><td colspan="3" style="text-align: center; padding: 20px;">Laden...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

  <div id="auditModal" class="modal">
    <div class="modal-content wide">
      <div class="modal-header">
        <h2 class="modal-title">Audit Log</h2>
        <button class="icon-btn" onclick="closeAuditModal()">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="admin-section">
          <h3 style="margin-bottom: 16px;">Activiteitenlogboek</h3>
          <div style="margin-bottom: 16px;">
            <input type="text" id="auditSearchInput" class="form-control" placeholder="Zoek op e-mail, actie of details...">
          </div>
          <table class="user-table" id="auditTable">
            <thead>
              <tr>
                <th>Datum/Tijd</th>
                <th>Gebruiker</th>
                <th>Actie</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="auditTableBody">
              <tr><td colspan="4" style="text-align: center; padding: 20px;">Laden...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="addModal" class="modal">
    <div class="modal-content wide">
      <div class="modal-header">
        <h2 class="modal-title">Nieuw systeem toevoegen</h2>
        <button class="icon-btn" onclick="closeAddModal()">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
               
      <form id="addForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Systeem Type</label>
            <select id="addSystemType" class="form-control" required onchange="updateAddFieldsForSystemType(this.value)">
              <option value="appendages">Appendages</option>
              <option value="collectief">Collectief</option>
              <option value="cv-ketel">CV-ketel</option>
              <option value="mv-wtw">MV/WTW</option>
              <option value="overig">Overig</option>
              <option value="rookgasafvoer">Rookgasafvoer</option>
              <option value="thermostaten">Thermostaten</option>
              <option value="warmtepomp">Warmtepomp</option>
              <option value="waterzijdig">Waterzijdig</option>
            </select>
          </div>
          <div class="form-group">
            <label>Merk</label>
            <input type="text" id="addBrand" class="form-control" required placeholder="Bijv. ATAG, Remeha, Nefit">
          </div>
          <div class="form-group">
            <label>Model</label>
            <input type="text" id="addModel" class="form-control" required placeholder="Bijv. HR Combi 35...">
          </div>
          <div class="form-group">
            <label>Logo URL (optioneel)</label>
            <input type="url" id="addLogoUrl" class="form-control" placeholder="https://example.com/logo.png">
          </div>
          <div class="form-group">
            <label>Foto van toestel (voor herkenning)</label>
            <input type="file" id="addDeviceImage" class="form-control" accept="image/*">
          </div>
          <div class="form-group">
            <label>Procedure</label>
            <textarea id="addProcedure" class="form-control" rows="6" required placeholder="Stap 1: ...&#10;Stap 2: ..."></textarea>
          </div>

          <div id="addCvKetelFields" style="display: none;">
            <div class="form-group">
              <label>O₂ Laaglast</label>
              <input type="text" id="addO2Low" class="form-control" placeholder="Bijv. 8,3 - 8,8">
            </div>
            <div class="form-group">
              <label>O₂ Hooglast</label>
              <input type="text" id="addO2High" class="form-control" placeholder="Bijv. 8,9 - 9,7">
            </div>
            <div class="form-group">
              <label>CO₂ Laaglast</label>
              <input type="text" id="addCO2Low" class="form-control" placeholder="Bijv. 8,5 - 9,0">
            </div>
            <div class="form-group">
              <label>CO₂ Hooglast</label>
              <input type="text" id="addCO2High" class="form-control" placeholder="Bijv. 9,0 - 9,5">
            </div>
            <div class="form-group">
              <label>Max PPM CO</label>
              <input type="text" id="addMaxCO" class="form-control" placeholder="Bijv. 200">
            </div>
          </div>

          <div class="form-group">
            <label>Fotos (max 5 - optioneel)</label>
            <div class="upload-zone" id="addUploadZone" 
                 ondrop="handleDrop(event, 'add')"
                 ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over')"
                 ondragleave="event.currentTarget.classList.remove('drag-over')"
                 onclick="document.getElementById('addImageInput').click()">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; margin: 0 auto;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p>Sleep fotos hier of klik om te uploaden</p>
              <input type="file" id="addImageInput" accept="image/*" multiple onchange="handleImageSelect(this.files, 'add')">
              <div class="image-count" id="addImageCount">0/5 fotos</div>
            </div>
            <div class="image-gallery" id="addImageGallery"></div>
          </div>

          <div id="addWarmtepompFields" style="display: none;">
            <p style="color: var(--color-text-secondary); font-size: 14px; margin: 16px 0;">
              Voor warmtepompen worden geen O₂/CO metingen gedaan - alleen onderhoud
            </p>
          </div>

          <div id="addOtherFields" style="display: none;">
            <p style="color: var(--color-text-secondary); font-size: 14px; margin: 16px 0;">
              Voor dit type systeem zijn geen specifieke meetwaardes vereist.
            </p>
          </div>

          <div class="form-group">
            <label>Benodigde pakkingen/artikelen</label>
            <div id="addPartsContainer"></div>
              <button type="button" class="btn" style="font-size: 12px; margin-top: 4px;" onclick="addPartRow('add')">+ Regel toevoegen</button>
              <input type="hidden" id="addParts">
          </div>

            <div class="form-group" style="margin-top: 16px; border-top: 1px solid var(--color-border); padding-top: 16px;">
            <label>Aandachtspunten / Controle</label>
            <div id="addChecksContainer"></div>
            <button type="button" class="btn" style="font-size: 12px; margin-top: 4px;" onclick="addCheckRow('add')">+ Controlepunt toevoegen</button>
          </div>
               
          <div class="form-group" style="margin-top: 16px; border-top: 1px solid var(--color-border); padding-top: 16px;">
            <label>Storingscodes & Oplossingen</label>
            <div id="addFaultsContainer"></div>
            <button type="button" class="btn" style="font-size: 12px; margin-top: 4px;" onclick="addFaultRow('add')">+ Storing toevoegen</button>
          </div>
          
          <div class="form-group">
            <label>Opmerkingen</label>
            <textarea id="addNotes" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Handleiding datum (YYYY-MM-DD, optioneel)</label>
            <input type="date" id="addHandbookDate" class="form-control">
          </div>
          <div class="form-group">
            <label>Link naar handleiding (URL)</label>
            <input type="url" id="addManualUrl" class="form-control" placeholder="https://...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" onclick="closeAddModal()">Annuleren</button>
          <button type="submit" class="btn btn-primary">Systeem toevoegen</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content wide">
      <div class="modal-header">
        <h2 class="modal-title">Systeem bewerken</h2>
        <button class="icon-btn" onclick="closeEditModal()">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <input type="hidden" id="editId">
          <input type="hidden" id="editSystemType">
          <div class="form-group">
            <label>Merk</label>
            <input type="text" id="editBrand" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Model</label>
            <input type="text" id="editModel" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Logo URL (optioneel)</label>
            <input type="url" id="editLogoUrl" class="form-control" placeholder="https://example.com/logo.png">
          </div>
          <div class="form-group">
            <label>Foto van toestel (voor herkenning)</label>
            <input type="file" id="editDeviceImage" class="form-control" accept="image/*">
            <div id="editDeviceImagePreview" style="font-size:12px; margin-top:4px; color:var(--color-success);"></div>
          </div>
          <div class="form-group">
            <label>Procedure</label>
            <textarea id="editProcedure" class="form-control" rows="6" required></textarea>
          </div>

          <div id="cvKetelFields">
            <div class="form-group">
              <label>O₂ Laaglast</label>
              <input type="text" id="editO2Low" class="form-control" placeholder="Bijv. 8,3 - 8,8">
            </div>
            <div class="form-group">
              <label>O₂ Hooglast</label>
              <input type="text" id="editO2High" class="form-control" placeholder="Bijv. 8,9 - 9,7">
            </div>
            <div class="form-group">
              <label>CO₂ Laaglast</label>
              <input type="text" id="editCO2Low" class="form-control" placeholder="Bijv. 8,5 - 9,0">
            </div>
            <div class="form-group">
              <label>CO₂ Hooglast</label>
              <input type="text" id="editCO2High" class="form-control" placeholder="Bijv. 9,0 - 9,5">
            </div>
            <div class="form-group">
              <label>Max PPM CO</label>
              <input type="text" id="editMaxCO" class="form-control" placeholder="Bijv. 200">
            </div>
          </div>

          <div class="form-group">
            <label>Fotos (max 5 - optioneel)</label>
            <div class="upload-zone" id="editUploadZone" 
                 ondrop="handleDrop(event, 'edit')"
                 ondragover="event.preventDefault(); event.currentTarget.classList.add('drag-over')"
                 ondragleave="event.currentTarget.classList.remove('drag-over')"
                 onclick="document.getElementById('editImageInput').click()">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; margin: 0 auto;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p>Sleep fotos hier of klik om te uploaden</p>
              <input type="file" id="editImageInput" accept="image/*" multiple onchange="handleImageSelect(this.files, 'edit')">
              <div class="image-count" id="editImageCount">0/5 fotos</div>
            </div>
            <div class="image-gallery" id="editImageGallery"></div>
          </div>

          <div id="warmtepompFields" style="display: none;">
            <p style="color: var(--color-text-secondary); font-size: 14px; margin: 16px 0;">
              Voor warmtepompen worden geen O₂/CO metingen gedaan - alleen onderhoud
            </p>
          </div>

          <div id="otherFields" style="display: none;">
            <p style="color: var(--color-text-secondary); font-size: 14px; margin: 16px 0;">
              Voor dit type systeem zijn geen specifieke meetwaardes vereist.
            </p>
          </div>

          <div class="form-group">
            <label>Benodigde pakkingen/artikelen</label>
            <div id="editPartsContainer"></div>
            <button type="button" class="btn" style="font-size: 12px; margin-top: 4px;" onclick="addPartRow('edit')">+ Regel toevoegen</button>
            <input type="hidden" id="editParts">
          </div>

          <div class="form-group" style="margin-top: 16px; border-top: 1px solid var(--color-border); padding-top: 16px;">
            <label>Aandachtspunten / Controle</label>
            <div id="editChecksContainer"></div>
            <button type="button" class="btn" style="font-size: 12px; margin-top: 4px;" onclick="addCheckRow('edit')">+ Controlepunt toevoegen</button>
          </div>
          
          <div class="form-group" style="margin-top: 16px; border-top: 1px solid var(--color-border); padding-top: 16px;">
            <label>Storingscodes & Oplossingen</label>
            <div id="editFaultsContainer"></div>
            <button type="button" class="btn" style="font-size: 12px; margin-top: 4px;" onclick="addFaultRow('edit')">+ Storing toevoegen</button>
          </div>
          
          <div class="form-group">
            <label>Opmerkingen</label>
            <textarea id="editNotes" class="form-control" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Handleiding datum (YYYY-MM-DD, optioneel)</label>
            <input type="date" id="editHandbookDate" class="form-control">
          </div>
          <div class="form-group">
            <label>Link naar handleiding (URL)</label>
            <input type="url" id="editManualUrl" class="form-control" placeholder="https://...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" onclick="closeEditModal()">Annuleren</button>
          <button type="submit" class="btn btn-primary">Opslaan</button>
        </div>
      </form>
    </div>
  </div>

  
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Nieuw account registreren</h2>
        <button class="icon-btn" onclick="closeRegisterModal()">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="registerForm">
        <div class="modal-body">
          <div class="form-group">
            <label for="registerEmail">E-mail</label>
            <input type="email" id="registerEmail" class="form-control" required placeholder="monteur@bedrijf.nl">
          </div>
          <div class="form-group">
            <label for="registerPassword">Wachtwoord</label>
            <input type="password" id="registerPassword" class="form-control" required placeholder="Minimaal 6 tekens">
          </div>
          <div class="form-group">
            <label for="registerPassword2">Herhaal wachtwoord</label>
            <input type="password" id="registerPassword2" class="form-control" required placeholder="Bevestig wachtwoord">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" onclick="closeRegisterModal()">Annuleren</button>
          <button type="submit" class="btn btn-primary">Account aanmaken</button>
        </div>
      </form>
    </div>
  </div>
  
  <div id="lightbox" class="lightbox">
    <div class="lightbox-content">
      <img id="lightboxImg" class="lightbox-img" alt="Uitvergrote foto">
      <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    </div>
  </div>

  <button id="scrollTopBtn" class="btn btn-primary" style="position:fixed; bottom:20px; right:20px; display:none; border-radius:50%; width:50px; height:50px; padding:0; z-index:99; justify-content:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px; height:24px;">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
    </svg>
  </button>

  <script>
    const SUPABASE_URL = 'https://srsnjifezttivawxnndu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyc25qaWZlenR0aXZhd3hubmR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzY1MjcsImV4cCI6MjA3OTY1MjUyN30.5RmDp3QgAYX7yDS39KwoRtHc6c9Kp-wGKGYeJctoY7w';
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentUserRole = 'user';
    let systems = [];
    let favorites = [];
    let currentEditingId = null;
    let allUsers = [];
    let pendingImages = { add: [], edit: [] };
    let auditLogs = [];
    let auditFilterTerm = '';

    function activateEasterEgg() {
      
      const themes = [
        { bg: '#6C10F3', text: '#43EDC2' }, // Paars & Teal
        { bg: '#163C64', text: '#F76648' }, // Donkerblauw & Oranje
        { bg: '#DFDE2F', text: '#1E1D1C' },  // Geel & Donkergrijs
        { bg: '#FAD0C9', text: '#6E6E6D' } // Roze & Grijs
      ];
      
      const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            
      const target = document.documentElement;
      
      const props = {
        '--color-bg-primary': randomTheme.bg,
        '--color-surface': randomTheme.bg,
        '--color-text': randomTheme.text,
        '--color-text-secondary': randomTheme.text,
        '--color-primary': randomTheme.text,
        '--color-border': randomTheme.text,
        '--color-card-border': randomTheme.text,
        '--color-warning': randomTheme.text,
        '--color-success': randomTheme.text,
        '--color-error': randomTheme.text
      };
      
      for (const [key, value] of Object.entries(props)) {
        target.style.setProperty(key, value, 'important');
      }

      console.log('🐣 Easter Egg geactiveerd!');
    }

      function openRegisterModal() {
      document.getElementById('registerModal').classList.add('active');
    }

    function closeRegisterModal() {
      document.getElementById('registerModal').classList.remove('active');
      document.getElementById('registerForm').reset();
    }

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session) {
        currentUser = session.user;
        // Check of de gebruiker is goedgekeurd
        const isApproved = await checkUserApproval(session.user);
        
        if (isApproved) {
          showApp();
          await loadData();
        } else {
          showPendingScreen(session.user.email);
        }
      } else {
        showAuth();
      }



      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN') {
          currentUser = session.user;
          const isApproved = await checkUserApproval(session.user);
          if (isApproved) {
            showApp();
            loadData();
          } else {
            showPendingScreen(session.user.email);
          }
        } else if (event === 'SIGNED_OUT') {
          currentUser = null;
          showAuth();
        }
      });

      setupEventListeners();
      initTheme();
    }

    // NIEUW: Deze functie checkt de database
    async function checkUserApproval(user) {
      try {
        const { data, error } = await supabase
          .from('user_roles')
          .select('is_approved')
          .eq('user_id', user.id)
          .maybeSingle();

        if (error) throw error;
        
        // Als er geen rij is, maken we er eentje aan (standaard niet goedgekeurd)
        if (!data) {
          await supabase.from('user_roles').insert([
            { user_id: user.id, email: user.email, is_approved: false }
          ]);
          return false;
        }
        
        return data.is_approved;
      } catch (err) {
        console.error("Fout bij checken goedkeuring:", err);
        return false;
      }
    }

    // NIEUW: Deze functie toont het 'Wacht' scherm
    function showPendingScreen(email) {
      document.getElementById('authContainer').classList.add('hidden');
      document.getElementById('appContainer').classList.add('hidden');
      
      // We maken even een simpel tijdelijk scherm
      let pendingDiv = document.getElementById('pendingScreen');
      if (!pendingDiv) {
        pendingDiv = document.createElement('div');
        pendingDiv.id = 'pendingScreen';
        pendingDiv.style = "display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; text-align:center; padding:20px; font-family:sans-serif; color:#134252;";
        document.body.appendChild(pendingDiv);
      }
      
      pendingDiv.innerHTML = `
        <h1 style="font-size: 24px; margin-bottom: 10px;">Toegang in afwachting ⏳</h1>
        <p style="margin-bottom: 20px;">Hoi <b>${email}</b>, je account moet nog worden goedgekeurd door de beheerder.</p>
        <button onclick="location.reload()" style="background:#218D8D; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin-bottom:10px;">Check opnieuw</button>
        <br>
        <button onclick="supabase.auth.signOut()" style="background:none; border:none; color:#c0152f; cursor:pointer; text-decoration:underline;">Uitloggen</button>
      `;
      pendingDiv.classList.remove('hidden');
    }

    function setupEventListeners() {
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    document.getElementById('adminBtn').addEventListener('click', openAdminModal);
    document.getElementById('addSystemBtn').addEventListener('click', openAddModal);
    document.getElementById('auditBtn').addEventListener('click', openAuditModal);
    document.getElementById('auditSearchInput')?.addEventListener('input', filterAuditLogs);
    document.getElementById('copyrightName').addEventListener('click', activateEasterEgg);
    
    // We gebruiken nu dropdowns, dus search listener is niet meer nodig op input
    // document.getElementById('searchInput').addEventListener('input', filterSystems); 

    document.getElementById('systemTypeFilter').addEventListener('change', () => {
        updateBrandFilter(); // Categorie gewijzigd? -> Merken aanpassen
        updateModelFilter(); // En daarna Modellen aanpassen
        filterSystems();     // En kaartjes filteren
    });

    document.getElementById('brandFilter').addEventListener('change', () => {
        updateModelFilter(); // Merk gewijzigd? -> Modellen aanpassen 
        filterSystems();     // En kaartjes filteren
    });

    document.getElementById('modelFilter').addEventListener('change', filterSystems);
    document.getElementById('favoritesFilter').addEventListener('change', filterSystems);
    document.getElementById('addForm').addEventListener('submit', handleAddSubmit);
    document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
      
    const adminToggleBtn = document.getElementById('adminToggleBtn');
    const adminActions = document.getElementById('adminActions');
    if (adminToggleBtn) { 
        adminToggleBtn.addEventListener('click', () => adminActions.classList.toggle('open'));
    } 
    const scrollBtn = document.getElementById('scrollTopBtn');
      if (scrollBtn) {
        window.addEventListener('scroll', () => {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollBtn.style.display = "flex";
            } else {
                scrollBtn.style.display = "none";
            }
        });

        scrollBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }
}

    function showAuth() {
      document.getElementById('authContainer').classList.remove('hidden');
      document.getElementById('appContainer').classList.add('hidden');
    }

    async function showApp() {
      document.getElementById('authContainer').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      document.getElementById('userEmail').textContent = currentUser?.email;
      await loadUserRole();
      updateUIForRole();
    }

    async function loadUserRole() {
      try {
        const { data, error } = await supabase
          .from('user_roles')
          .select('role')
          .eq('user_id', currentUser.id)
          .single();
        if (!error && data) currentUserRole = data.role;
        else currentUserRole = 'user';
      } catch {
        currentUserRole = 'user';
      }
    }

    function updateUIForRole() {
      const canEdit = currentUserRole === 'admin' || currentUserRole === 'moderator';
      const isAdmin = currentUserRole === 'admin';
      document.getElementById('addSystemBtn').style.display = canEdit ? 'inline-flex' : 'none';
      document.getElementById('adminBtn').style.display = isAdmin ? 'inline-flex' : 'none';
      document.getElementById('auditBtn').style.display = isAdmin ? 'inline-flex' : 'none';
      document.getElementById('adminToggleBtn').style.display = canEdit ? 'inline-flex' : 'none';
      document.querySelectorAll('.icon-btn[onclick*="openEditModal"]').forEach(btn => {
        btn.style.display = canEdit ? 'block' : 'none';
      });
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;

      const password = document.getElementById('loginPassword').value;
      
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert('Login mislukt: ' + error.message);
      document.getElementById('loginForm').reset();
    }

    async function handleLogout() {
      await supabase.auth.signOut();
    }

    async function loadData() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('cardsGrid').classList.add('hidden');
      try {
        const { data: systemsData, error: systemsError } = await supabase
          .from('systems')
          .select('*')
          .order('brand', { ascending: true })
          .order('model', { ascending: true });
        if (systemsError) throw systemsError;
        systems = systemsData;

        if (currentUser) {
          const { data: favsData } = await supabase
            .from('favorites')
            .select('system_id')
            .eq('user_id', currentUser.id);
          favorites = favsData ? favsData.map(f => f.system_id) : [];
        }
        updateBrandFilter();
        // Model filter updaten we pas als er een merk gekozen is, of initieel op 'alles'
        updateModelFilter(); 
        filterSystems();
      } catch (error) {
        console.error('Error loading data:', error);
        alert('Fout bij laden van gegevens: ' + error.message);
      } finally {
        document.getElementById('loadingState').classList.add('hidden');
      }
    }

    function updateBrandFilter() {
      const selectedType = document.getElementById('systemTypeFilter').value;
      const select = document.getElementById('brandFilter');
      const currentVal = select.value; // Onthoud wat er gekozen was
      
      // Stap 1: Filter alles op basis van categorie
      let availableSystems = systems;
      if (selectedType) {
          if (selectedType === 'mv-wtw') {
              availableSystems = systems.filter(s => s.systemtype === 'mv-wtw' || s.systemtype === 'wtw-mv');
          } else {
              availableSystems = systems.filter(s => s.systemtype === selectedType);
          }
      }

      // Stap 2: Maak de lijst met merken
      const brands = [...new Set(availableSystems.map(s => s.brand))].sort();
      
      select.innerHTML = '<option value="all">Alle Merken</option>';
      brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        select.appendChild(option);
      });

      // Stap 3: Probeer de oude keuze te herstellen, anders reset naar 'all'
      if(brands.includes(currentVal)) {
          select.value = currentVal;
      } else {
          select.value = 'all';
      }
    }

    function updateModelFilter() {
        const selectedType = document.getElementById('systemTypeFilter').value;
        const selectedBrand = document.getElementById('brandFilter').value;
        const modelSelect = document.getElementById('modelFilter');
        
        // Reset de lijst
        modelSelect.innerHTML = '<option value="all">Alle Modellen</option>';

        // Stap 1: Begin met alle systemen
        let availableSystems = systems;

        // Stap 2: Filter eerst op Categorie (indien gekozen)
        if (selectedType) {
            if (selectedType === 'mv-wtw') {
                availableSystems = availableSystems.filter(s => s.systemtype === 'mv-wtw' || s.systemtype === 'wtw-mv');
            } else {
                availableSystems = availableSystems.filter(s => s.systemtype === selectedType);
            }
        }

        // Stap 3: Filter daarna op Merk (DIT IS CRUCIAAL)
        if (selectedBrand !== 'all') {
            availableSystems = availableSystems.filter(s => s.brand === selectedBrand);
        }

        // Stap 4: Vul de dropdown met de overgebleven modellen
        const models = [...new Set(availableSystems.map(s => s.model))].sort();
        
        if (models.length > 0) {
            modelSelect.disabled = false;
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        } else {
            // Als er geen modellen zijn (of je hebt 'Alle merken' en 'Alle categorieën' en de lijst is te lang)
            // Laten we hem 'enabled' maar leeg (behalve 'Alle modellen')
            modelSelect.disabled = false; 
        }
    }

    function filterSystems() {
      const selectedType = document.getElementById('systemTypeFilter').value; 
      const selectedBrand = document.getElementById('brandFilter').value;
      const selectedModel = document.getElementById('modelFilter').value;
      const showFavoritesOnly = document.getElementById('favoritesFilter').value === 'favorites';

      const filtered = systems.filter(system => {
        
        // 1. Type filter
        let matchesType = true;
        if (selectedType) { 
            if (selectedType === 'mv-wtw') {
                matchesType = system.systemtype === 'mv-wtw' || system.systemtype === 'wtw-mv';
            } else {
                // Werkt nu ook voor waterzijdig en overig
                matchesType = system.systemtype === selectedType;
            }
        }

        // 2. Merk filter
        const matchesBrand = selectedBrand === 'all' || system.brand === selectedBrand;
        
        // 3. Model filter
        const matchesModel = selectedModel === 'all' || system.model === selectedModel;

        // 4. Favorieten filter
        const matchesFavorites = !showFavoritesOnly || favorites.includes(system.id);

        return matchesType && matchesBrand && matchesModel && matchesFavorites;
      });

      renderSystems(filtered);
      updateResultsCount(filtered.length);
    }

    function updateResultsCount(count) {
      const text = count === 1 ? 'systeem gevonden' : 'systemen gevonden';
      const favText = favorites.length === 0 ? '' : ' | ' + favorites.length + ' favorieten totaal';
      document.getElementById('resultsCount').textContent = count + ' ' + text + favText;
    }

    function renderSystems(systemsList) {
      const grid = document.getElementById('cardsGrid');
      const emptyState = document.getElementById('emptyState');
      if (systemsList.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      grid.classList.remove('hidden');
      emptyState.classList.add('hidden');
      grid.innerHTML = systemsList.map(system => createSystemCard(system)).join('');
    }

    // 1. Invulregel toevoegen (Met foto upload mogelijkheid)
    function addCheckRow(mode, subject = '', problem = '', solution = '', imgUrl = '') {
      const container = document.getElementById(mode + 'ChecksContainer');
      const div = document.createElement('div');
      div.className = 'part-input-row';
      div.style.display = 'block'; // Overschrijf grid voor meer ruimte
      div.style.border = '1px solid var(--color-border)';
      div.style.padding = '8px';
      div.style.borderRadius = '8px';
      
      div.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">
            <input type="text" placeholder="Onderwerp (bijv. Sifon)" class="form-control check-subject" value="${escapeInput(subject)}">
            <input type="file" class="form-control check-file" accept="image/*">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">
            <textarea placeholder="Wat kan er mis zijn?" class="form-control check-problem" rows="2">${escapeInput(problem)}</textarea>
            <textarea placeholder="Oplossing" class="form-control check-solution" rows="2">${escapeInput(solution)}</textarea>
        </div>
        
        <!-- Verborgen veld om oude URL te onthouden bij bewerken -->
        <input type="hidden" class="check-existing-url" value="${imgUrl}">
        ${imgUrl ? `<div style="font-size:12px; color:green;">✓ Huidige foto: <a href="${imgUrl}" target="_blank">Bekijk</a></div>` : ''}
        
        <button type="button" class="btn" style="width:100%; margin-top:4px; color:var(--color-error); border-color:var(--color-error);" onclick="this.parentElement.remove()">Verwijder dit controlepunt</button>
      `;
      container.appendChild(div);
    }

    // 2. Formulier vullen (bij bewerken)
    function populateChecksForm(mode, jsonString) {
      const container = document.getElementById(mode + 'ChecksContainer');
      container.innerHTML = '';
      if (!jsonString) return;
      try {
        const checks = JSON.parse(jsonString);
        if (Array.isArray(checks)) {
          checks.forEach(c => addCheckRow(mode, c.subject, c.problem, c.solution, c.imgUrl));
        }
      } catch (e) { console.error('Fout bij laden checks', e); }
    }

     // Deze functie is 'async' omdat hij moet wachten op uploads
    async function processChecksData(mode) {
      const container = document.getElementById(mode + 'ChecksContainer');
      const rows = Array.from(container.children); // Maak er een array van
      const checks = [];

      for (const row of rows) {
        const subject = row.querySelector('.check-subject').value.trim();
        const problem = row.querySelector('.check-problem').value.trim();
        const solution = row.querySelector('.check-solution').value.trim();
        const fileInput = row.querySelector('.check-file');
        const existingUrl = row.querySelector('.check-existing-url').value;

        if (!subject && !problem) continue; // Lege regels overslaan

        let finalImageUrl = existingUrl;

        // Als er een nieuwe foto is gekozen, uploaden we die nu direct
        if (fileInput.files.length > 0) {
           const file = fileInput.files[0];
           const fileExt = file.name.split('.').pop();
           const fileName = 'check-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9) + '.' + fileExt;
           
           try {
             const { data, error } = await supabase.storage
               .from('system-images')
               .upload(fileName, file, { upsert: true });
               
             if (!error) {
               finalImageUrl = 'https://srsnjifezttivawxnndu.supabase.co/storage/v1/object/public/system-images/' + fileName;
             }
           } catch(err) {
             console.error('Foto upload fout bij controlepunt', err);
           }
        }

        checks.push({ subject, problem, solution, imgUrl: finalImageUrl });
      }

      return checks.length > 0 ? JSON.stringify(checks) : null;
    }
    
    function createSystemCard(system) {
      const isFavorite = favorites.includes(system.id);
      const canEdit = currentUserRole === 'admin' || currentUserRole === 'moderator';
      
      // --- TAB NAAM LOGICA ---
      let tabLabel = 'Afstelling';
      let procedureTitle = 'Afstelprocedure';

      if (['rookgasafvoer', 'appendages', 'waterzijdig', 'collectief', 'overig', 'thermostaten'].includes(system.systemtype)) {
          tabLabel = 'Inspectie';
          procedureTitle = 'Inspectieprocedure';
      } else if (system.systemtype === 'mv-wtw' || system.systemtype === 'wtw-mv') {
          tabLabel = 'Onderhoud';
          procedureTitle = 'Onderhoudsprocedure';
      }

      // 1. Content: EERSTE TABBLAD (Onderhoud/Afstelling/Inspectie)
      let maintenanceContent = `
          <div class="card-section">
            <div class="card-section-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              ${procedureTitle}
            </div>
            <div class="procedure-text">${escapeHtml(system.procedure) || 'Geen procedure opgegeven'}</div>
          </div>
      `;

      // Waardes
      if (system.o2_low || system.o2_high || system.co2_low || system.co2_high || system.maxco) {
        maintenanceContent += '<div class="card-section"><div class="card-section-title">Doelwaarden</div><div class="values-grid">' +
          (system.o2_low ? '<div class="value-item"><span class="value-icon" style="color: var(--color-success);"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span><div class="value-content"><div class="value-label">O₂ Laaglast</div><div class="value-number">' + escapeHtml(system.o2_low) + '</div></div></div>' : '') +
          (system.o2_high ? '<div class="value-item"><span class="value-icon" style="color: var(--color-success);"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span><div class="value-content"><div class="value-label">O₂ Hooglast</div><div class="value-number">' + escapeHtml(system.o2_high) + '</div></div></div>' : '') +
          (system.co2_low ? '<div class="value-item"><span class="value-icon" style="color: var(--color-text-secondary);"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg></span><div class="value-content"><div class="value-label">CO₂ Laaglast</div><div class="value-number">' + escapeHtml(system.co2_low) + '</div></div></div>' : '') +
          (system.co2_high ? '<div class="value-item"><span class="value-icon" style="color: var(--color-text-secondary);"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg></span><div class="value-content"><div class="value-label">CO₂ Hooglast</div><div class="value-number">' + escapeHtml(system.co2_high) + '</div></div></div>' : '') +
          (system.maxco ? '<div class="value-item"><span class="value-icon" style="color: var(--color-warning);"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></span><div class="value-content"><div class="value-label">Max PPM CO</div><div class="value-number">' + escapeHtml(system.maxco) + '</div></div></div>' : '') +
          '</div></div>';
      }

      // Fotos
      if (system.images && system.images.length > 0) {
        const imagesList = system.images.map((img, idx) => 
          `<div class="gallery-item" onclick="openLightbox(this.querySelector('img').src)">
             <img src="${escapeHtml(img)}" alt="Foto ${idx + 1}" loading="lazy">
           </div>`
        ).join('');
        maintenanceContent += `<div class="card-section"><div class="card-section-title">Fotos</div><div class="image-gallery">${imagesList}</div></div>`;
      }

      // Opmerkingen
      if (system.notes) {
        maintenanceContent += `<div class="notes-section"><div class="notes-title">Opmerkingen</div><div class="notes-text">${escapeHtml(system.notes)}</div></div>`;
      }

      // 2. Content: MATERIALEN
      let materialsContent = '';
      if (system.parts) {
         try {
           const parts = JSON.parse(system.parts);
           if (Array.isArray(parts) && parts.length > 0) {
             materialsContent = '<div class="parts-list"><div class="parts-title" style="display:flex; align-items:center; gap:8px;"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>Benodigde pakkingen/artikelen</div><table class="parts-table"><thead><tr><th>Artikel</th><th>Art. nr.</th><th>Lev.</th></tr></thead><tbody>';
             materialsContent += parts.map(p => {
               const badgeClass = p.supp === 'Rensa' ? 'supplier-rensa' : (p.supp === 'Wasco' ? 'supplier-wasco' : 'supplier-other');
               const artNr = escapeHtml(p.art);
               const link = p.supp === 'Rensa' ? `https://rensa.nl/Product/${artNr}` : (p.supp === 'Wasco' ? `https://www.wasco.nl/artikel/${artNr}` : null);
               const displayArt = link ? `<a href="${link}" target="_blank" style="color:var(--color-primary); text-decoration:none; border-bottom:1px dotted;">${artNr} ↗</a>` : artNr;
               return `<tr><td>${escapeHtml(p.desc)}</td><td style="font-family:monospace;">${displayArt}</td><td><span class="supplier-badge ${badgeClass}">${escapeHtml(p.supp)}</span></td></tr>`;
             }).join('');
             materialsContent += '</tbody></table></div>';
           } else {
             materialsContent = '<div style="padding:20px; text-align:center; color:var(--color-text-secondary);">Geen materialenlijst beschikbaar.</div>';
           }
         } catch(e) { 
             materialsContent = `<div class="parts-list"><div class="parts-title">Benodigde materialen</div><div class="parts-text">${escapeHtml(system.parts)}</div></div>`; 
         }
      } else {
         materialsContent = '<div style="padding:20px; text-align:center; color:var(--color-text-secondary);">Geen materialen toegevoegd.</div>';
      }

      // 3. Content: CONTROLE
      let checksContent = '';
      if (system.checks) {
        try {
            const checks = JSON.parse(system.checks);
            if (Array.isArray(checks) && checks.length > 0) {
                checksContent = checks.map(c => `
                    <div class="check-card">
                        <div class="check-title">${escapeHtml(c.subject)}</div>
                        <div class="check-row">
                            <div class="check-label">Probleem:</div>
                            <div>${escapeHtml(c.problem)}</div>
                        </div>
                        <div class="check-row">
                            <div class="check-label">Oplossing:</div>
                            <div>${escapeHtml(c.solution)}</div>
                        </div>
                        ${c.imgUrl ? `<img src="${c.imgUrl}" class="check-img" onclick="openLightbox(this.src)" loading="lazy" alt="Foto bij ${escapeHtml(c.subject)}">` : ''}
                    </div>
                `).join('');
            } else {
                checksContent = '<div style="padding:20px; text-align:center; color:var(--color-text-secondary);">Geen aandachtspunten bekend.</div>';
            }
        } catch(e) { checksContent = 'Data error'; }
      } else {
        checksContent = '<div style="padding:20px; text-align:center; color:var(--color-text-secondary);">Nog geen aandachtspunten toegevoegd.</div>';
      }

      // 4. Content: STORINGEN
      let faultsContent = '';
      if (system.faults) {
        try {
            const faults = JSON.parse(system.faults);
            if (Array.isArray(faults) && faults.length > 0) {
                faultsContent = faults.map(f => {
                    const cause = f.cause || '';
                    const solution = f.solution || f.sol || '';
                    return `
                    <div class="fault-row">
                        <div class="fault-code">${escapeHtml(f.code)}</div>
                        <div style="font-size:13px; color:var(--color-text);">
                            ${cause ? `<div class="fault-detail-item"><span class="fault-label">Oorzaak:</span>${escapeHtml(cause)}</div>` : ''}
                            ${solution ? `<div class="fault-detail-item"><span class="fault-label">Oplossing:</span>${escapeHtml(solution)}</div>` : ''}
                        </div>
                    </div>
                `}).join('');
            } else {
                faultsContent = '<div style="padding:20px; text-align:center; color:var(--color-text-secondary);">Geen storingen bekend.</div>';
            }
        } catch(e) { faultsContent = 'Data error'; }
      } else {
        faultsContent = '<div style="padding:20px; text-align:center; color:var(--color-text-secondary);">Nog geen storingen toegevoegd.</div>';
      }

      return `
        <div class="system-card" id="card-${system.id}">
          <div class="card-header">
            <div class="card-header-with-logo">
              ${system.logo_url ? '<img src="' + escapeHtml(system.logo_url) + '" alt="logo" class="brand-logo" onerror="this.style.display=\'none\'">' : ''}
              
              <div class="card-header-text">
                <div class="brand-label">${escapeHtml(system.brand)}</div>
                <div class="model-label">${escapeHtml(system.model)}</div>
                
                <!-- DATUM + LINK SECTIE -->
                <div style="margin-top: 4px; display: flex; flex-direction: column; gap: 2px;">
                    ${system.handbook_date ? '<div class="card-meta">📅 Handleiding: ' + new Date(system.handbook_date).toLocaleDateString('nl-NL') + '</div>' : ''}
                    
                    ${system.manual_url ? `
                        <a href="${escapeHtml(system.manual_url)}" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; font-size: 13px; color: var(--color-primary); text-decoration: none; font-weight: 500;">
                            <svg class="icon" style="width:14px; height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            Open handleiding
                        </a>
                    ` : ''}
                </div>
              </div>
            </div>
            
            <div class="card-actions">
              ${system.device_image_url ? `
              <button class="icon-btn" onclick="openLightbox('${system.device_image_url}')" title="Bekijk toestel">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
              </button>
              ` : ''}
              <button class="icon-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${system.id}')">
                <svg class="icon" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
              </button>
              ${canEdit ? `
                <button class="icon-btn" onclick="openEditModal('${system.id}')"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                <button class="icon-btn" onclick="deleteSystem('${system.id}')" style="color: var(--color-error);"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
              ` : ''}
            </div>
          </div>

          <div class="tabs-nav">
            <button class="tab-btn active" data-tab="maint" onclick="switchTab('${system.id}', 'maint')">${tabLabel}</button>
            <button class="tab-btn" data-tab="parts" onclick="switchTab('${system.id}', 'parts')">Materialen</button>
            <button class="tab-btn" data-tab="checks" onclick="switchTab('${system.id}', 'checks')">Controle</button>
            <button class="tab-btn" data-tab="faults" onclick="switchTab('${system.id}', 'faults')">Storingen</button>
          </div>

          <div id="content-maint-${system.id}" class="tab-content active">
             ${maintenanceContent}
          </div>
          <div id="content-parts-${system.id}" class="tab-content">
             ${materialsContent}
          </div>
          <div id="content-checks-${system.id}" class="tab-content">
             ${checksContent}
          </div>
          <div id="content-faults-${system.id}" class="tab-content">
             ${faultsContent}
          </div>
        </div>
      `;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      if (theme === 'dark') {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
      }
    }

    async function openAdminModal() {
      document.getElementById('adminModal').classList.add('active');
      await loadUsers();
      await loadPendingUsers();
    }

    function closeAdminModal() {
      document.getElementById('adminModal').classList.remove('active');
    }

    async function openAuditModal() {
      document.getElementById('auditModal').classList.add('active');
      await loadAuditLogs();
    }

    function closeAuditModal() {
      document.getElementById('auditModal').classList.remove('active');
    }

    async function loadAuditLogs() {
      try {
        const { data, error } = await supabase
          .from('audit_logs')
          .select('*')
          .order('timestamp', { ascending: false })
          .limit(200);
        if (error) throw error;
        auditLogs = data || [];
        renderAuditTable(auditLogs);
      } catch (error) {
        console.error('Error loading audit logs:', error);
        document.getElementById('auditTableBody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--color-error);">Fout bij laden logboek</td></tr>';
      }
    }

    function renderAuditTable(logs) {
      const tbody = document.getElementById('auditTableBody');
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Geen logboekitems gevonden</td></tr>';
        return;
      }
      tbody.innerHTML = logs.map(log => {
        const date = new Date(log.timestamp).toLocaleString('nl-NL');
        const actionLabel = log.action === 'system_created' ? '✨ Systeem aangemaakt' : 
                           log.action === 'system_updated' ? '✏️ Systeem bijgewerkt' : 
                           log.action === 'role_change' ? '👤 Rol gewijzigd' : log.action;
        return '<tr><td style="font-size: 13px;">' + date + '</td><td>' + escapeHtml(log.user_email) + '</td><td>' + actionLabel + '</td><td style="font-size: 13px; max-width: 300px; word-break: break-word;">' + escapeHtml(log.details || '') + '</td></tr>';
      }).join('');
    }

    function filterAuditLogs() {
      auditFilterTerm = document.getElementById('auditSearchInput').value.toLowerCase();
      const filtered = auditLogs.filter(log => {
        return (log.user_email?.toLowerCase().includes(auditFilterTerm)) ||
               (log.action?.toLowerCase().includes(auditFilterTerm)) ||
               (log.details?.toLowerCase().includes(auditFilterTerm));
      });
      renderAuditTable(filtered);
    }

    async function loadUsers() {
      try {
        // Gebruik de RPC-functie om gebruikers + rollen op te halen
        const { data, error } = await supabase
          .rpc('get_all_users_with_roles')
          .order('email', { ascending: true });
        
        if (error) throw error;
        
        allUsers = (data || []).map(u => ({
          id: u.user_id,
          email: u.email,
          role: u.role || 'user'
        }));
        
        renderUsersTable();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--color-error);">Fout bij laden gebruikers. Zorg ervoor dat de RPC-functie "get_all_users_with_roles" bestaat.</td></tr>';
      }
    }

    function renderUsersTable() {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = allUsers.map(user => '<tr><td>' + escapeHtml(user.email) + '</td><td><span class="role-badge ' + user.role + '">' + user.role + '</span></td><td><select onchange="updateUserRole(\'' + user.id + '\', this.value)" class="form-control" style="width: 150px;"><option value="user" ' + (user.role === 'user' ? 'selected' : '') + '>User</option><option value="moderator" ' + (user.role === 'moderator' ? 'selected' : '') + '>Moderator</option><option value="admin" ' + (user.role === 'admin' ? 'selected' : '') + '>Admin</option></select></td></tr>').join('');
    }

    async function updateUserRole(userId, newRole) {
      try {
        const { error } = await supabase
          .from('user_roles')
          .upsert({ user_id: userId, role: newRole }, { onConflict: 'user_id' });
        if (error) throw error;
        await logAuditEvent('role_change', `Gebruiker ${userId} rol gewijzigd naar ${newRole}`);
        const user = allUsers.find(u => u.id === userId);
        if (user) user.role = newRole;
        renderUsersTable();
        alert('Rol bijgewerkt!');
      } catch (error) {
        console.error('Error updating role:', error);
        alert('Fout bij bijwerken rol: ' + error.message);
      }
    }

    async function logAuditEvent(action, details) {
      if (!currentUser) return;
      try {
        const { error } = await supabase.from('audit_logs').insert({
          user_id: currentUser.id,
          user_email: currentUser.email,
          action: action,
          details: details,
          timestamp: new Date().toISOString()
        });
        if (error) throw error;
      } catch (error) {
        console.error('Fout bij logging:', error);
      }
    }

    async function deleteSystem(systemId) {
      if (!confirm('Weet je zeker dat je dit systeem wilt verwijderen? Dit kan niet ongedaan worden gemaakt.')) {
        return;
      }

      try {
        // 1. Verwijder uit database
        const { error } = await supabase
          .from('systems')
          .delete()
          .eq('id', systemId);

        if (error) throw error;

        // 2. Log de actie
        const system = systems.find(s => s.id === systemId);
        await logAuditEvent('system_deleted', `Systeem verwijderd: ${system ? system.brand + ' ' + system.model : systemId}`);

        // 3. Update de lijst lokaal (zodat je niet hoeft te refreshen)
        systems = systems.filter(s => s.id !== systemId);
        updateBrandFilter();
        // Na verwijderen model filter resetten of updaten
        updateModelFilter();
        filterSystems(); // Lijst opnieuw tekenen

        alert('Systeem verwijderd.');
      } catch (error) {
        console.error('Error deleting system:', error);
        alert('Fout bij verwijderen: ' + error.message);
      }
    }
    
    async function toggleFavorite(systemId) {
      if (!currentUser) return;
      const isFavorite = favorites.includes(systemId);
      try {
        if (isFavorite) {
          const { error } = await supabase
            .from('favorites')
            .delete()
            .eq('user_id', currentUser.id)
            .eq('system_id', systemId);
          if (error) throw error;
          favorites = favorites.filter(id => id !== systemId);
        } else {
          const { error } = await supabase
            .from('favorites')
            .insert({ user_id: currentUser.id, system_id: systemId });
          if (error) throw error;
          favorites.push(systemId);
        }
        filterSystems();
      } catch (error) {
        console.error('Error toggling favorite:', error);
        alert('Fout bij opslaan favoriet: ' + error.message);
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const password2 = document.getElementById('registerPassword2').value;
      if (password !== password2) {
        alert('Wachtwoorden komen niet overeen.');
        return;
      }
      try {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) throw error;
        const newUserId = data.user?.id;
        if (newUserId) {
          const { error: roleError } = await supabase
            .from('user_roles')
            .insert({ user_id: newUserId, role: 'user' });
          if (roleError) console.error('Fout bij opslaan rol:', roleError);
        }
        alert('Account aangemaakt. Controleer je e-mail (indien bevestiging nodig) en log daarna in.');
        closeRegisterModal();
        document.getElementById('registerForm').reset();
      } catch (err) {
        console.error('Fout bij registreren:', err);
        alert('Registratie mislukt: ' + err.message);
      }
    }

    function openEditModal(systemId) {
      const system = systems.find(s => s.id === systemId);
      if (!system) return;
      currentEditingId = systemId;
      document.getElementById('editId').value = systemId;
      document.getElementById('editSystemType').value = system.systemtype;
      document.getElementById('editBrand').value = system.brand;
      document.getElementById('editModel').value = system.model;
      document.getElementById('editLogoUrl').value = system.logo_url || '';
      
      const devImgInput = document.getElementById('editDeviceImage');
      const devImgPreview = document.getElementById('editDeviceImagePreview');
      devImgInput.value = ''; // Reset input
      if (system.device_image_url) {
          devImgInput.dataset.currentUrl = system.device_image_url;
          devImgPreview.innerHTML = `✓ Huidige foto: <a href="${system.device_image_url}" target="_blank">Bekijk</a>`;
      } else {
          devImgInput.dataset.currentUrl = '';
          devImgPreview.innerHTML = '';
      }
      
      document.getElementById('editProcedure').value = system.procedure;
      document.getElementById('editO2Low').value = system.o2_low || '';
      document.getElementById('editO2High').value = system.o2_high || '';
      document.getElementById('editCO2Low').value = system.co2_low || '';
      document.getElementById('editCO2High').value = system.co2_high || '';
      document.getElementById('editMaxCO').value = system.maxco || '';
      populatePartsForm('edit', system.parts);
      populateFaultsForm('edit', system.faults);
      populateChecksForm('edit', system.checks);
      document.getElementById('editNotes').value = system.notes || '';
      if (document.getElementById('editHandbookDate')) {
        document.getElementById('editHandbookDate').value = system.handbook_date || '';
      }
        document.getElementById('editManualUrl').value = system.manual_url || '';
      pendingImages.edit = system.images || [];
      renderImagePreview('edit');
      updateFieldsForSystemType(system.systemtype);
      document.getElementById('editModal').classList.add('active');
    }

    function updateFieldsForSystemType(type) {
      const cvFields = document.getElementById('cvKetelFields');
      const wpFields = document.getElementById('warmtepompFields');
      const wtwFields = document.getElementById('wtwMvFields');
      const otherFields = document.getElementById('otherFields');
      
      // Reset alles
      if(cvFields) cvFields.style.display = 'none';
      if(wpFields) wpFields.style.display = 'none';
      if(wtwFields) wtwFields.style.display = 'none';
      if(otherFields) otherFields.style.display = 'none';

      if (type === 'cv-ketel') {
          if(cvFields) cvFields.style.display = 'block';
      } else if (type === 'warmtepomp') {
          if(wpFields) wpFields.style.display = 'block';
      } else if (type === 'wtw-mv' || type === 'mv-wtw') {
          if(wtwFields) wtwFields.style.display = 'block';
      } else if (['waterzijdig', 'overig', 'collectief', 'appendages', 'rookgasafvoer', 'thermostaten'].includes(type)) {
          if(otherFields) otherFields.style.display = 'block';
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      currentEditingId = null;
    }

    function openAddModal() {
      document.getElementById('addModal').classList.add('active');
      document.getElementById('addFaultsContainer').innerHTML = '';
      document.getElementById('addDeviceImage').value = '';
      document.getElementById('addForm').reset();
      document.getElementById('addPartsContainer').innerHTML = '';
      document.getElementById('addChecksContainer').innerHTML = '';
      pendingImages.add = [];
      renderImagePreview('add');
      updateAddFieldsForSystemType();
      
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.remove('active');
    }

    function updateAddFieldsForSystemType(type = '') {
      const cvFields = document.getElementById('addCvKetelFields');
      const wpFields = document.getElementById('addWarmtepompFields');
      const wtwFields = document.getElementById('addWtwMvFields');
      const otherFields = document.getElementById('addOtherFields');
      
      // Reset alles
      cvFields.style.display = 'none';
      wpFields.style.display = 'none';
      wtwFields.style.display = 'none';
      otherFields.style.display = 'none';

      if (type === 'cv-ketel') {
          cvFields.style.display = 'block';
      } else if (type === 'warmtepomp') {
          wpFields.style.display = 'block';
      } else if (type === 'wtw-mv' || type === 'mv-wtw') {
          wtwFields.style.display = 'block';
      } else if (['waterzijdig', 'overig', 'collectief', 'appendages', 'rookgasafvoer', 'thermostaten'].includes(type)) {
          otherFields.style.display = 'block';
      }
    }

    async function handleAddSubmit(e) {
      e.preventDefault();
      
      const systemType = document.getElementById('addSystemType').value;
      
      const checksJson = await processChecksData('add');

      let deviceImgUrl = null;
      const deviceFile = document.getElementById('addDeviceImage').files[0];
      if (deviceFile) {
          try { deviceImgUrl = await uploadSingleFile(deviceFile); } 
          catch(err) { console.error(err); alert('Fout bij uploaden toestelfoto'); return; }
      }

      const newSystem = {
        systemtype: systemType,
        brand: document.getElementById('addBrand').value,
        model: document.getElementById('addModel').value,
        logo_url: document.getElementById('addLogoUrl').value || null,
        device_image_url: deviceImgUrl, // <--- NIEUWE REGEL
        procedure: document.getElementById('addProcedure').value,
        parts: collectPartsData('add'),
        faults: collectFaultsData('add'),
        checks: checksJson,
        notes: document.getElementById('addNotes').value || null
      };
      
      newSystem.handbook_date = document.getElementById('addHandbookDate').value || null;
      newSystem.manual_url = document.getElementById('addManualUrl').value || null;

      if (systemType === 'cv-ketel') {
        newSystem.o2_low = document.getElementById('addO2Low').value || null;
        newSystem.o2_high = document.getElementById('addO2High').value || null;
        newSystem.co2_low = document.getElementById('addCO2Low').value || null;
        newSystem.co2_high = document.getElementById('addCO2High').value || null;
        newSystem.maxco = document.getElementById('addMaxCO').value || null;
      } else {
        newSystem.o2_low = null;
        newSystem.o2_high = null;
        newSystem.co2_low = null;
        newSystem.co2_high = null;
        newSystem.maxco = null;
      }

      try {
        let imageUrls = [];
        // Hier wordt systemType gebruikt voor de bestandsnaam van de hoofdfoto's
        if (pendingImages.add.length > 0) {
          imageUrls = await uploadImages(systemType + '-' + Date.now(), pendingImages.add);
        }
        newSystem.images = imageUrls;

        const { data, error } = await supabase
          .from('systems')
          .insert([newSystem])
          .select();
          
        if (error) throw error;
        
        if (data && data.length > 0) {
          systems.push(data[0]);
          await logAuditEvent('system_created', `Systeem ${newSystem.brand} ${newSystem.model} (${systemType}) aangemaakt`);
        }
        
        pendingImages.add = [];
        closeAddModal();
        updateBrandFilter();
        // Ook model filter updaten na toevoegen
        updateModelFilter();
        filterSystems();
        alert('Systeem succesvol toegevoegd!');
      } catch (error) {
        console.error('Error adding system:', error);
        alert('Fout bij toevoegen systeem: ' + error.message);
      }
    }

    async function handleEditSubmit(e) {
      e.preventDefault();
      
      const systemType = document.getElementById('editSystemType').value || 'update';
      
      const checksJson = await processChecksData('edit');

      let deviceImgUrl = document.getElementById('editDeviceImage').dataset.currentUrl || null;
      const deviceFile = document.getElementById('editDeviceImage').files[0];
      
      if (deviceFile) {
          try { deviceImgUrl = await uploadSingleFile(deviceFile); } 
          catch(err) { console.error(err); alert('Fout bij uploaden toestelfoto'); return; }
      }

      const updates = {
        brand: document.getElementById('editBrand').value,
        model: document.getElementById('editModel').value,
        logo_url: document.getElementById('editLogoUrl').value || null,
        device_image_url: deviceImgUrl, // <--- NIEUWE REGEL
        procedure: document.getElementById('editProcedure').value,
        parts: collectPartsData('edit'),
        faults: collectFaultsData('edit'),
        checks: checksJson, 
        notes: document.getElementById('editNotes').value || null
      };
      
      updates.handbook_date = document.getElementById('editHandbookDate').value || null;
      updates.manual_url = document.getElementById('editManualUrl').value || null;

      
      if (systemType === 'cv-ketel') {
        updates.o2_low = document.getElementById('editO2Low').value || null;
        updates.o2_high = document.getElementById('editO2High').value || null;
        updates.co2_low = document.getElementById('editCO2Low').value || null;
        updates.co2_high = document.getElementById('editCO2High').value || null;
        updates.maxco = document.getElementById('editMaxCO').value || null;
      } else {
        updates.o2_low = null;
        updates.o2_high = null;
        updates.co2_low = null;
        updates.co2_high = null;
        updates.maxco = null;
      }

      try {
        let imageUrls = pendingImages.edit;
        if (pendingImages.edit.some(img => img instanceof File)) {
          const newFiles = pendingImages.edit.filter(img => img instanceof File);
          // Hier wordt systemType voor de tweede keer gebruikt:
          const uploadedUrls = await uploadImages(systemType + '-' + Date.now(), newFiles);
          const existingUrls = pendingImages.edit.filter(img => typeof img === 'string');
          imageUrls = existingUrls.concat(uploadedUrls);
        }
        const { error } = await supabase
          .from('systems')
          .update({ ...updates, images: imageUrls })
          .eq('id', currentEditingId);
        if (error) throw error;
        
        const systemIndex = systems.findIndex(s => s.id === currentEditingId);
        if (systemIndex !== -1) {
          systems[systemIndex] = Object.assign({}, systems[systemIndex], updates, { images: imageUrls });
          await logAuditEvent('system_updated', `Systeem ${updates.brand} ${updates.model} bijgewerkt`);
        }
        
        pendingImages.edit = [];
        closeEditModal();
        updateBrandFilter();
        updateModelFilter(); // En ook hier
        filterSystems();
        alert('Systeem succesvol bijgewerkt!');
      } catch (error) {
        console.error('Error editing system:', error);
        alert('Fout bij bewerken systeem: ' + error.message);
      }
    }
    
    function handleDrop(e, mode) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      handleImageSelect(files, mode);
    }

    function handleImageSelect(files, mode) {
      const maxFiles = 5;
      const newFiles = Array.from(files).slice(0, maxFiles - pendingImages[mode].length);
      pendingImages[mode] = pendingImages[mode].concat(newFiles.filter(f => f instanceof File));
      renderImagePreview(mode);
    }

    function renderImagePreview(mode) {
      const gallery = document.getElementById(mode === 'add' ? 'addImageGallery' : 'editImageGallery');
      const count = document.getElementById(mode === 'add' ? 'addImageCount' : 'editImageCount');
      gallery.innerHTML = pendingImages[mode].map((file, idx) => {
        const isFile = file instanceof File;
        const src = isFile ? URL.createObjectURL(file) : file;
        return '<div class="gallery-item"><img src="' + src + '" alt="Preview ' + (idx + 1) + '"><button class="gallery-item-delete" onclick="removeImage(' + idx + ', \'' + mode + '\')">&times;</button></div>';
      }).join('');
      count.textContent = pendingImages[mode].length + '/5 fotos';
    }

    function removeImage(index, mode) {
      pendingImages[mode].splice(index, 1);
      renderImagePreview(mode);
    }

    async function uploadImages(folderName, files) {
      const urls = [];
      console.log("Start uploaden naar bucket: system-images"); // Debug regel

      for (let file of files) {
        if (!(file instanceof File)) continue;
        
        // Bestandsnaam genereren
        const fileExt = file.name.split('.').pop();
        const fileName = folderName + '-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9) + '.' + fileExt;
        
        // LET OP: Hieronder staat nu 'system-images' (zonder s)
        const { data, error } = await supabase.storage
          .from('system-images') 
          .upload(fileName, file, { upsert: true });
          
        if (error) {
          console.error('Upload error:', error);
          alert('Fout bij uploaden foto: ' + error.message);
        } else {
          console.log("Upload gelukt:", fileName); // Debug regel
          // LET OP: Hieronder ook 'system-images' (zonder s)
          urls.push('https://srsnjifezttivawxnndu.supabase.co/storage/v1/object/public/system-images/' + fileName);
        }
      }
      return urls;
    }

    async function uploadSingleFile(file) {
      if (!file) return null;
      const fileExt = file.name.split('.').pop();
      const fileName = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9) + '.' + fileExt;
      const { error } = await supabase.storage.from('system-images').upload(fileName, file);
      if (error) { throw error; }
      return 'https://srsnjifezttivawxnndu.supabase.co/storage/v1/object/public/system-images/' + fileName;
    }

    function escapeInput(str) {
      return str ? str.replace(/"/g, '&quot;') : '';
    }

    function addPartRow(mode, desc = '', art = '', supp = 'Overig') {
      const container = document.getElementById(mode + 'PartsContainer');
      const div = document.createElement('div');
      div.className = 'part-input-row';
      div.innerHTML = `
        <input type="text" placeholder="Omschrijving" class="form-control part-desc" value="${escapeInput(desc)}">
        <input type="text" placeholder="Art. nr." class="form-control part-art" value="${escapeInput(art)}">
        <select class="form-control part-supp">
          <option value="Overig" ${supp === 'Overig' ? 'selected' : ''}>Overig</option>
          <option value="Rensa" ${supp === 'Rensa' ? 'selected' : ''}>Rensa</option>
          <option value="Wasco" ${supp === 'Wasco' ? 'selected' : ''}>Wasco</option>
        </select>
        <button type="button" class="remove-part-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      container.appendChild(div);
    }

    // === NIEUWE FUNCTIES VOOR STORINGEN ===

    // 1. Tabblad wisselen
    function switchTab(systemId, tabName) {
      // Zoek de kaart van dit systeem
      const card = document.getElementById('card-' + systemId);
      
      // Knoppen updaten
      card.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      card.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');

      // Content updaten
      card.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      card.querySelector(`#content-${tabName}-${systemId}`).classList.add('active');
    }

    // 2. Invoer regel toevoegen (voor Modal)
    function addFaultRow(mode, code = '', cause = '', solution = '') {
      const container = document.getElementById(mode + 'FaultsContainer');
      const div = document.createElement('div');
      div.className = 'part-input-row';
      div.innerHTML = `
        <input type="text" placeholder="Code" class="form-control fault-code-input" value="${escapeInput(code)}">
        <input type="text" placeholder="Oorzaak" class="form-control fault-cause-input" value="${escapeInput(cause)}">
        <input type="text" placeholder="Oplossing" class="form-control fault-sol-input" value="${escapeInput(solution)}">
        <button type="button" class="remove-part-btn" onclick="this.parentElement.remove()">&times;</button>
      `;
      container.appendChild(div);
    }

    // 3. Data verzamelen (voor opslaan)
    function collectFaultsData(mode) {
      const container = document.getElementById(mode + 'FaultsContainer');
      const rows = container.querySelectorAll('.part-input-row');
      const faults = [];
      rows.forEach(row => {
        const code = row.querySelector('.fault-code-input').value.trim();
        const cause = row.querySelector('.fault-cause-input').value.trim();
        const solution = row.querySelector('.fault-sol-input').value.trim();
        
        // Opslaan als er tenminste iets is ingevuld
        if (code || cause || solution) {
            faults.push({ code, cause, solution });
        }
      });
      return faults.length > 0 ? JSON.stringify(faults) : null;
    }

    // 4. Formulier vullen (bij bewerken)
    function populateFaultsForm(mode, jsonString) {
      const container = document.getElementById(mode + 'FaultsContainer');
      container.innerHTML = '';
      if (!jsonString) return;
      try {
        const faults = JSON.parse(jsonString);
        if (Array.isArray(faults)) {
          faults.forEach(f => {
              // HIER ZIT DE TRUC: 
              // We kijken of 'cause' bestaat. Zo niet, is het misschien oude data?
              // Oude data had 'sol'. Die stoppen we dan in 'solution' zodat er niks kwijtraakt.
              const cause = f.cause || '';
              const solution = f.solution || f.sol || ''; 
              addFaultRow(mode, f.code, cause, solution);
          });
        }
      } catch (e) { console.error('Fout bij laden storingen', e); }
    }

    // Deze functie verzamelt alle data uit de inputs en maakt er JSON van voor de database
    function collectPartsData(mode) {
      const container = document.getElementById(mode + 'PartsContainer');
      const rows = container.querySelectorAll('.part-input-row');
      const parts = [];
      rows.forEach(row => {
        const desc = row.querySelector('.part-desc').value.trim();
        const art = row.querySelector('.part-art').value.trim();
        const supp = row.querySelector('.part-supp').value;
        if (desc || art) {
          parts.push({ desc, art, supp });
        }
      });
      // Als er data is, slaan we het op als JSON string. Zo niet, null.
      return parts.length > 0 ? JSON.stringify(parts) : null;
    }

    function populatePartsForm(mode, jsonString) {
      const container = document.getElementById(mode + 'PartsContainer');
      container.innerHTML = ''; // Leegmaken
      
      if (!jsonString) return; // Niets te doen

      try {
        // Probeer te kijken of het JSON is (nieuwe stijl)
        const parts = JSON.parse(jsonString);
        if (Array.isArray(parts)) {
          parts.forEach(p => addPartRow(mode, p.desc, p.art, p.supp));
          return;
        }
      } catch (e) {
        // Het is geen JSON, dus waarschijnlijk oude "platte tekst"
        // We proberen het slim om te zetten: elke regel is een item
        const lines = jsonString.split('\n');
        lines.forEach(line => {
          if(line.trim()) addPartRow(mode, line, '', 'Overig');
        });
      }
    }
    
    function openLightbox(imageUrl) {
      document.getElementById('lightbox').classList.add('active');
      document.getElementById('lightboxImg').src = imageUrl;
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
    }
    
    document.getElementById('currentYear').textContent = new Date().getFullYear();

// Functie 1: Haal niet-goedgekeurde gebruikers op
async function loadPendingUsers() {
  const container = document.getElementById('pendingUsersList');
  if (!container) return; // Veiligheid

  const { data, error } = await supabase
    .from('user_roles')
    .select('*')
    .eq('is_approved', false);

  container.innerHTML = '';

  if (error) {
    console.error(error);
    container.innerHTML = '<p style="color:red">Fout bij laden aanvragen.</p>';
    return;
  }

  if (!data || data.length === 0) {
    container.innerHTML = '<p style="font-size:13px; color:green;">✓ Geen openstaande aanvragen.</p>';
    return;
  }

  data.forEach(user => {
    const row = document.createElement('div');
    row.style = "display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--color-bg-primary); border:1px solid var(--color-border); border-radius:8px; margin-bottom:8px;";
    row.innerHTML = `
      <span style="font-weight:500;">${user.email}</span>
      <button onclick="approveUser('${user.user_id}')" class="btn btn-primary" style="padding:4px 12px; font-size:12px;">
        Toelaten
      </button>
    `;
    container.appendChild(row);
  });
}

// Functie 2: Keur een gebruiker goed
async function approveUser(userId) {
  if(!confirm('Wil je deze gebruiker toegang geven?')) return;

  const { error } = await supabase
    .from('user_roles')
    .update({ is_approved: true })
    .eq('user_id', userId);

  if (error) {
    alert("Fout bij goedkeuren: " + error.message);
  } else {
    // Ververs beide lijsten
    loadPendingUsers(); 
    loadUsers(); 
    // Log de actie
    if(typeof logAuditEvent === 'function') {
        logAuditEvent('user_approved', `Gebruiker ${userId} goedgekeurd`);
    }
  }
}
    
    init();
        
</script>  
</body>
</html>







